name: Build and Release Data

on:
  push:
    branches: [ "main" ]
    paths:
      - 'data/**'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Build Database
      run: python scripts/build_db.py
      
    - name: Compress Database
      run: gzip -k liumo_full.db
      
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
      
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: data-${{ steps.date.outputs.date }}
        name: Data Update ${{ steps.date.outputs.date }}
        files: |
          liumo_full.db.gz
          fonts/*.ttf
        draft: false
        prerelease: false
